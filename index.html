<script type="module">
  // === 1️⃣ Firebase Setup ===
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT.firebaseio.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const appFB = initializeApp(firebaseConfig);
  const db = getDatabase(appFB);

  // === 2️⃣ Existing app logic ===
  const teamMembers = [
    { name:"Asha AS", email:"asha.as@opendoor.com", empid:"010293" },
    { name:"Revathi Kumar", email:"revathi.kumar@opendoor.com", empid:"010113" },
    { name:"Kamesh D", email:"d.kamesh@opendoor.com", empid:"010193" }
    // ... add rest of your members
  ];

  const app = document.getElementById("app");

  // --- Local helpers ---
  function getCurrentEmpid() { return localStorage.getItem('bt_current_empid'); }
  function setCurrentEmpid(id){ localStorage.setItem('bt_current_empid', id); }
  function clearCurrentEmpid(){ localStorage.removeItem('bt_current_empid'); }

  // --- Registration/Login simplified for demo ---
  function showLogin() {
    app.innerHTML = `
      <div class="centered">
        <h2>Login</h2>
        <select id="nameSel">${teamMembers.map(m=>`<option value="${m.empid}">${m.name}</option>`).join('')}</select>
        <button class="btn" id="loginBtn">Login</button>
      </div>`;
    document.getElementById("loginBtn").onclick = () => {
      const empid = document.getElementById("nameSel").value;
      setCurrentEmpid(empid);
      showDashboard();
    };
  }

  // --- Dashboard display ---
  function showDashboard() {
    const empid = getCurrentEmpid();
    if (!empid) return showLogin();

    app.innerHTML = `
      <div class="dashboard">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2>Team Break Dashboard</h2>
          <button class="btn" onclick="logout()">Logout</button>
        </div>
        <div id="teamStatus"></div>
        <div class="break-controls" style="margin-top:20px;">
          <button class="btn" id="startBtn">Start Break</button>
          <button class="btn" id="endBtn">End Break</button>
        </div>
      </div>
    `;

    document.getElementById("startBtn").onclick = startBreak;
    document.getElementById("endBtn").onclick = endBreak;

    // Listen for real-time updates
    const teamRef = ref(db, "teamStatus");
    onValue(teamRef, (snapshot) => {
      const data = snapshot.val() || {};
      renderTeamStatus(data);
    });
  }

  // --- Render team statuses ---
  function renderTeamStatus(data) {
    const currentEmpid = getCurrentEmpid();
    let html = "<table><tr><th>Name</th><th>Status</th></tr>";
    teamMembers.forEach(m => {
      const status = data[m.empid]?.status || "Active";
      const isCurrent = m.empid === currentEmpid;
      html += `
        <tr>
          <td>${m.name}${isCurrent ? " (You)" : ""}</td>
          <td style="color:${status==='Break' ? '#fa7540':'#42b242'}">${status}</td>
        </tr>`;
    });
    html += "</table>";
    document.getElementById("teamStatus").innerHTML = html;
  }

  // --- Start/End break handlers ---
  async function startBreak() {
    const empid = getCurrentEmpid();
    if (!empid) return;
    await update(ref(db, "teamStatus/" + empid), {
      status: "Break",
      updatedAt: Date.now()
    });
  }

  async function endBreak() {
    const empid = getCurrentEmpid();
    if (!empid) return;
    await update(ref(db, "teamStatus/" + empid), {
      status: "Active",
      updatedAt: Date.now()
    });
  }

  // --- Logout ---
  function logout() {
    clearCurrentEmpid();
    showLogin();
  }

  // --- Boot ---
  if (getCurrentEmpid()) showDashboard();
  else showLogin();
</script>
